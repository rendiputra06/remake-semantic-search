{% extends "layout.html" %}
{% block title %}Evaluasi Pencarian - Versi 3 (Advanced){% endblock %}

{% block content %}
<style>
.weight-slider-container {
  background: linear-gradient(to right, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 10px;
  transition: all 0.3s ease;
}

.weight-slider-container:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.metric-card {
  border-left: 4px solid;
  transition: all 0.3s ease;
}

.metric-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.15);
}

.metric-card.precision { border-color: #28a745; }
.metric-card.recall { border-color: #17a2b8; }
.metric-card.f1 { border-color: #ffc107; }

.winner-badge {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: bold;
}
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="fas fa-flask me-2 text-primary"></i>
                Evaluasi Pencarian 
                <span class="badge bg-primary">Versi 3 - Advanced</span>
            </h2>
            <p class="text-muted mb-0">
                <i class="fas fa-info-circle me-1"></i>
                Evaluasi dengan konfigurasi ensemble lanjutan dan analisis mendalam
            </p>
        </div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/">Beranda</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('public.evaluasi') }}">Evaluasi</a></li>
                <li class="breadcrumb-item active">Versi 3</li>
            </ol>
        </nav>
    </div>

    <div class="row g-4">
        <!-- Panel Query (Kiri) -->
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search me-2"></i>Query Evaluasi
                        <span class="badge bg-light text-primary ms-2" id="query-count">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <form id="form-add-query" class="mb-3">
                        <div class="mb-3">
                            <label for="query-text" class="form-label fw-bold">Query Text</label>
                            <input type="text" class="form-control form-control-lg" id="query-text"
                                   placeholder="Masukkan query evaluasi..." required />
                        </div>
                        <button type="submit" class="btn btn-primary w-100 btn-lg">
                            <i class="fas fa-plus me-2"></i>Tambah Query
                        </button>
                    </form>
                    <hr>
                    <div id="query-list" class="query-list">
                        <!-- Daftar query akan dimuat di sini -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Utama (Kanan) -->
        <div class="col-lg-8">
            <!-- Panel Ayat Relevan -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-check-circle me-2"></i>Ayat Relevan
                        <span class="badge bg-light text-success ms-2" id="ayat-count">0</span>
                    </h5>
                </div>
                <div class="card-body" id="relevant-verse-section">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-info-circle fa-3x mb-3 text-info"></i>
                        <p>Pilih query untuk melihat/mengelola ayat relevan.</p>
                    </div>
                    <div id="relevant-verse-list"></div>
                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <button class="btn btn-info d-none" id="evaluasi-btn">
                            <i class="fas fa-eye me-1"></i>Detail Ayat Relevan
                        </button>
                        <button class="btn btn-primary" id="import-ayat-excel-btn">
                            <i class="fas fa-file-excel me-1"></i>Import dari Excel
                        </button>
                        <button class="btn btn-warning btn-reset-relevant-verses d-none" id="reset-relevant-verses-btn">
                            <i class="fas fa-undo me-1"></i>Reset Ayat
                        </button>
                    </div>

                    <!-- Form Evaluasi dengan Konfigurasi Lanjutan -->
                    <form id="form-evaluasi" class="mt-4 d-none">
                        <div class="row g-3 align-items-end mb-3">
                            <div class="col-md-8">
                                <label for="input-query-text" class="form-label fw-bold">Query Evaluasi</label>
                                <input type="text" class="form-control" id="input-query-text"
                                       placeholder="Query evaluasi (wajib)" required readonly />
                            </div>
                            <div class="col-md-4">
                                <label for="result-limit" class="form-label fw-bold">Limit Hasil</label>
                                <select class="form-select" id="result-limit">
                                    <option value="10" selected>10 hasil</option>
                                    <option value="20">20 hasil</option>
                                    <option value="50">50 hasil</option>
                                    <option value="0">Semua hasil</option>
                                </select>
                            </div>
                        </div>

                        <!-- Toggle Button for Advanced Settings -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="toggle-advanced-settings">
                                <i class="fas fa-cog me-1"></i>Pengaturan Ensemble Lanjutan
                            </button>
                        </div>

                        <!-- Advanced Ensemble Settings Panel -->
                        <div id="advanced-settings" class="card mb-3" style="display: none;">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-sliders-h me-2"></i>Konfigurasi Ensemble
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Quick Presets -->
                                <div class="mb-4">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-magic me-1 text-primary"></i>Quick Presets
                                    </label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary quick-preset-btn" data-preset="balanced">
                                            <i class="fas fa-balance-scale me-1"></i>Balanced
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success quick-preset-btn" data-preset="precision">
                                            <i class="fas fa-bullseye me-1"></i>Precision Focus
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info quick-preset-btn" data-preset="recall">
                                            <i class="fas fa-search-plus me-1"></i>Recall Focus
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning quick-preset-btn" data-preset="conservative">
                                            <i class="fas fa-shield-alt me-1"></i>Conservative
                                        </button>
                                    </div>
                                </div>

                                <!-- Ensemble Method -->
                                <div class="row mb-4">
                                    <div class="col-md-6 mb-3">
                                        <label for="ensemble-method" class="form-label fw-semibold">
                                            <i class="fas fa-project-diagram me-1 text-primary"></i>Metode Ensemble
                                        </label>
                                        <select class="form-select" id="ensemble-method">
                                            <option value="weighted" selected>Weighted Averaging</option>
                                            <option value="voting">Voting</option>
                                            <option value="meta">Meta-Ensemble (ML)</option>
                                            <option value="all">Semua (Perbandingan)</option>
                                        </select>
                                        <div class="form-text">Pilih metode penggabungan model</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="ensemble-threshold" class="form-label fw-semibold">
                                            <i class="fas fa-filter me-1 text-warning"></i>Threshold Ensemble
                                        </label>
                                        <input type="number" step="0.01" min="0" max="1" class="form-control" 
                                               id="ensemble-threshold" value="0.5" />
                                        <div class="form-text">Minimum skor untuk hasil ensemble</div>
                                    </div>
                                </div>

                                <!-- Model Weights -->
                                <div class="border-top pt-4">
                                    <h6 class="mb-3">
                                        <i class="fas fa-balance-scale me-2 text-info"></i>Bobot Model
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <div class="weight-slider-container">
                                                <label for="w2v-weight" class="form-label">
                                                    <i class="fas fa-robot me-1 text-primary"></i>Word2Vec
                                                    <span class="badge bg-primary ms-2" id="w2v-weight-val">1.0</span>
                                                </label>
                                                <input type="range" class="form-range" min="0" max="2" step="0.1" 
                                                       id="w2v-weight" value="1" />
                                                <div class="d-flex justify-content-between text-muted small">
                                                    <span>0.0</span>
                                                    <span>Pengaruh: <span id="w2v-impact">Normal</span></span>
                                                    <span>2.0</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="weight-slider-container">
                                                <label for="ft-weight" class="form-label">
                                                    <i class="fas fa-font me-1 text-warning"></i>FastText
                                                    <span class="badge bg-warning text-dark ms-2" id="ft-weight-val">1.0</span>
                                                </label>
                                                <input type="range" class="form-range" min="0" max="2" step="0.1" 
                                                       id="ft-weight" value="1" />
                                                <div class="d-flex justify-content-between text-muted small">
                                                    <span>0.0</span>
                                                    <span>Pengaruh: <span id="ft-impact">Normal</span></span>
                                                    <span>2.0</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="weight-slider-container">
                                                <label for="glove-weight" class="form-label">
                                                    <i class="fas fa-globe me-1 text-info"></i>GloVe
                                                    <span class="badge bg-info ms-2" id="glove-weight-val">1.0</span>
                                                </label>
                                                <input type="range" class="form-range" min="0" max="2" step="0.1" 
                                                       id="glove-weight" value="1" />
                                                <div class="d-flex justify-content-between text-muted small">
                                                    <span>0.0</span>
                                                    <span>Pengaruh: <span id="glove-impact">Normal</span></span>
                                                    <span>2.0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Additional Parameters -->
                                <div class="border-top pt-4 mt-3">
                                    <h6 class="mb-3">
                                        <i class="fas fa-cogs me-2 text-secondary"></i>Parameter Tambahan
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="voting-bonus" class="form-label fw-semibold">
                                                <i class="fas fa-trophy me-1 text-success"></i>Voting Bonus
                                            </label>
                                            <input type="number" step="0.01" min="0" max="0.5" class="form-control" 
                                                   id="voting-bonus" value="0.05" />
                                            <div class="form-text">Bonus untuk ayat di ≥2 model</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check form-switch mt-4">
                                                <input class="form-check-input" type="checkbox" id="use-voting-filter">
                                                <label class="form-check-label fw-semibold" for="use-voting-filter">
                                                    <i class="fas fa-filter me-1"></i>Filter Voting (≥2 model)
                                                </label>
                                                <div class="form-text">Hanya tampilkan ayat dari minimal 2 model</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Model Selection -->
                        <div class="mb-3">
                            <label class="fw-bold mb-3 fs-5">
                                <i class="fas fa-cogs me-2"></i>Pilih Model Evaluasi:
                            </label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white py-2">
                                            <h6 class="mb-0"><i class="fas fa-font me-1"></i>Lexical</h6>
                                        </div>
                                        <div class="card-body py-2">
                                            <div class="form-check">
                                                <input class="form-check-input eval-method" type="checkbox"
                                                       value="lexical" id="method-lexical" checked />
                                                <label class="form-check-label" for="method-lexical">
                                                    <strong>Lexical</strong> - Pencarian berbasis kata
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-info">
                                        <div class="card-header bg-info text-white py-2">
                                            <h6 class="mb-0"><i class="fas fa-brain me-1"></i>Model Semantik</h6>
                                        </div>
                                        <div class="card-body py-2">
                                            <button type="button" class="btn btn-sm btn-outline-info mb-2 select-all-methods">
                                                <i class="fas fa-check-square me-1"></i>Select All
                                            </button>
                                            <div class="form-check">
                                                <input class="form-check-input eval-method" type="checkbox"
                                                       value="word2vec" id="method-word2vec" checked />
                                                <label class="form-check-label" for="method-word2vec">
                                                    <strong>Word2Vec</strong>
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input eval-method" type="checkbox"
                                                       value="fasttext" id="method-fasttext" checked />
                                                <label class="form-check-label" for="method-fasttext">
                                                    <strong>FastText</strong>
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input eval-method" type="checkbox"
                                                       value="glove" id="method-glove" checked />
                                                <label class="form-check-label" for="method-glove">
                                                    <strong>GloVe</strong>
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input eval-method" type="checkbox"
                                                       value="ensemble" id="method-ensemble" checked />
                                                <label class="form-check-label" for="method-ensemble">
                                                    <strong>Ensemble</strong> - Kombinasi model
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success w-100 btn-lg">
                            <i class="fas fa-play me-2"></i>Jalankan Evaluasi
                        </button>
                    </form>
                </div>
            </div>

            <!-- Panel Hasil Evaluasi -->
            <div class="card shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Hasil Evaluasi
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button class="btn btn-success" id="export-evaluasi-btn">
                            <i class="fas fa-download me-2"></i>Export ke Excel
                        </button>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="view-mode" id="table-view" checked>
                            <label class="btn btn-outline-primary btn-sm" for="table-view">
                                <i class="fas fa-table me-1"></i>Table
                            </label>
                            <input type="radio" class="btn-check" name="view-mode" id="chart-view">
                            <label class="btn btn-outline-primary btn-sm" for="chart-view">
                                <i class="fas fa-chart-line me-1"></i>Chart
                            </label>
                            <input type="radio" class="btn-check" name="view-mode" id="comparison-view">
                            <label class="btn btn-outline-primary btn-sm" for="comparison-view">
                                <i class="fas fa-columns me-1"></i>Comparison
                            </label>
                        </div>
                    </div>
                    <div id="evaluasi-result" class="mb-2"></div>
                    <div id="evaluasi-chart" class="d-none" style="height: 400px;"></div>
                    <div id="evaluasi-comparison" class="d-none"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals (reuse from v2) -->
<div class="modal fade" id="ayatDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detail Ayat Relevan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-add-verse-modal" class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="verse-ref-modal"
                               placeholder="Format: surah:ayat (misal: 2:255)" required />
                        <button class="btn btn-success" type="submit">Tambah Ayat</button>
                    </div>
                </form>
                <div id="ayat-detail-content">Memuat detail ayat...</div>
                <!-- Load More Button (match V2) -->
                <div class="text-center mt-3 d-none" id="load-more-container">
                    <button class="btn btn-outline-primary" id="load-more-btn">
                        <span id="load-more-text">Muat Lebih Banyak</span>
                        <span class="spinner-border spinner-border-sm d-none" id="load-more-spinner"></span>
                    </button>
                    <div class="text-muted small mt-2">
                        <span id="loaded-count">0</span> dari <span id="total-count">0</span> ayat ditampilkan
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalImportAyatExcel" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Ayat Relevan dari Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formImportAyatExcel">
                    <div class="mb-3">
                        <label for="inputExcelFile" class="form-label">Pilih File Excel</label>
                        <input class="form-control" type="file" id="inputExcelFile" accept=".xlsx,.xls" required />
                    </div>
                    <div class="mb-3 d-none" id="sheetSelectGroup">
                        <label for="selectSheet" class="form-label">Pilih Sheet</label>
                        <select class="form-select" id="selectSheet"></select>
                    </div>
                    <div class="mb-3 d-none" id="previewAyatGroup">
                        <label class="form-label">Preview Data Ayat</label>
                        <div id="previewAyatExcel" style="max-height: 200px; overflow: auto"></div>
                    </div>
                    <div class="alert alert-danger d-none" id="importAyatError"></div>
                    <button type="submit" class="btn btn-success w-100 d-none" id="submitImportAyatExcel">
                        Import Data Ayat
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/evaluasi_v3.js') }}"></script>
<script src="{{ url_for('static', filename='js/evaluasi_import_excel.js') }}"></script>
{% endblock %}
