{% extends "layout.html" %}
{% block title %}Uji & Visualisasi Model Ensemble{% endblock %}

<style>
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeOutDown {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(20px);
  }
}

.weight-slider-container {
  background: linear-gradient(to right, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 10px;
}

.weight-impact-indicator {
  font-size: 0.875rem;
  font-weight: 600;
  color: #495057;
}
</style>

{% block content %}
<div class="container">
  <h2 class="mb-4"><i class="fas fa-project-diagram me-2"></i>Uji & Visualisasi Model Ensemble</h2>
  <!-- Toggle Rumus Ensemble Button -->
  <div class="mb-2">
    <button type="button" class="btn btn-outline-info btn-sm" id="toggle-theory">
      <i class="fas fa-info-circle me-1"></i>Lihat Rumus Ensemble
    </button>
  </div>
  <!-- Panel Teori Ensemble (hidden by default) -->
  <div class="alert alert-info" id="ensemble-theory" style="display:none;">
    <h5 class="mb-2">Teori & Rumus Ensemble</h5>
    <ul class="mb-1">
      <li><b>Weighted Averaging:</b> <br>
        <code>Skor = (w1 × s1 + w2 × s2 + w3 × s3) / (w1 + w2 + w3)</code><br>
        <small>di mana <b>s1, s2, s3</b> adalah skor Word2Vec, FastText, GloVe dan <b>w1, w2, w3</b> adalah bobotnya. Hanya model dengan skor &gt; 0 yang dihitung.</small>
      </li>
      <li><b>Voting Bonus:</b> <br>
        Jika ayat muncul di <b>≥2 model</b> (voting ≥2), maka skor ensemble <b>ditambah bonus voting</b>:
        <br><code>Skor Ensemble Akhir = Skor Weighted + Bonus Voting</code>
        <br><small>Bonus voting diberikan pada semua metode (baik Weighted maupun Voting) jika voting ≥2.</small>
      </li>
      <li><b>Voting (di sistem ini):</b> <br>
        <code>Skor Voting = Skor Weighted + Bonus Voting (jika voting ≥2)</code><br>
        <small>Metode voting di sini <b>bukan majority voting klasik</b>, tapi tetap menggunakan weighted averaging + bonus voting.</small>
      </li>
      <li><b>Meta-Ensemble:</b> <br>
        Skor diprediksi oleh model machine learning (Logistic Regression) berdasarkan skor individual dan fitur tambahan.
      </li>
    </ul>
    <small>Ensemble menggabungkan keunggulan tiap model untuk hasil lebih robust dan relevan.<br>
    <b>Catatan:</b> Skor ensemble bisa tinggi meski voting hanya 1 jika skor model yang relevan sangat tinggi.</small>
  </div>
  
  <!-- Quick Search Buttons -->
  <div class="mb-3">
    <label class="form-label">Quick Search:</label>
    <div class="d-flex flex-wrap gap-2">
      <button type="button" class="btn btn-outline-primary btn-sm quick-search" data-query="ibadah">Ibadah</button>
      <button type="button" class="btn btn-outline-primary btn-sm quick-search" data-query="shalat">Shalat</button>
      <button type="button" class="btn btn-outline-primary btn-sm quick-search" data-query="puasa">Puasa</button>
      <button type="button" class="btn btn-outline-primary btn-sm quick-search" data-query="zakat">Zakat</button>
      <button type="button" class="btn btn-outline-primary btn-sm quick-search" data-query="haji">Haji</button>
    </div>
  </div>

  <form id="ensemble-form" class="mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-6">
        <label for="query" class="form-label">Query Pencarian</label>
        <input type="text" class="form-control" id="query" name="query" required placeholder="Masukkan kata kunci pencarian..." />
        <div class="form-text">Contoh: ibadah, shalat, puasa</div>
      </div>
      <div class="col-md-3">
        <label for="limit" class="form-label">Limit Hasil</label>
        <select class="form-select" id="limit" name="limit">
          <option value="10" selected>10 hasil</option>
          <option value="20">20 hasil</option>
          <option value="50">50 hasil</option>
          <option value="0">Semua hasil</option>
        </select>
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-search me-1"></i>Uji Ensemble
        </button>
      </div>
    </div>
    
    <!-- Toggle Button for Additional Settings -->
    <div class="row mt-3">
      <div class="col-12">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="toggle-settings">
          <i class="fas fa-cog me-1"></i>Pengaturan Lanjutan
        </button>
      </div>
    </div>
    
    <!-- Advanced Settings Panel -->
    <div id="additional-settings" class="card mt-3" style="display: none;">
      <div class="card-header bg-light">
        <h6 class="mb-0">
          <i class="fas fa-sliders-h me-2"></i>Pengaturan Lanjutan
        </h6>
      </div>
      <div class="card-body">
        <!-- Method & Core Settings -->
        <div class="row mb-4">
          <div class="col-lg-4 mb-3">
            <label for="method" class="form-label fw-semibold">
              <i class="fas fa-project-diagram me-1 text-primary"></i>Metode Ensemble
            </label>
            <select class="form-select" id="method" name="method">
              <option value="weighted">Weighted Averaging</option>
              <option value="voting">Voting</option>
              <option value="meta">Meta-Ensemble</option>
            </select>
            <div class="form-text">Pilih algoritma ensemble yang akan digunakan</div>
          </div>
          <div class="col-lg-4 mb-3">
            <label for="threshold" class="form-label fw-semibold">
              <i class="fas fa-filter me-1 text-warning"></i>Threshold
            </label>
            <input type="number" step="0.01" min="0" max="1" class="form-control" id="threshold" name="threshold" value="0.5" />
            <div class="form-text">Minimum skor kemiripan untuk hasil (0.0 - 1.0)</div>
          </div>
          <div class="col-lg-4 mb-3">
            <label for="voting_bonus" class="form-label fw-semibold">
              <i class="fas fa-trophy me-1 text-success"></i>Voting Bonus
            </label>
            <input type="number" step="0.01" min="0" max="1" class="form-control" id="voting_bonus" name="voting_bonus" value="0.05" />
            <div class="form-text">Bonus skor untuk ayat yang muncul di ≥2 model</div>
          </div>
        </div>

        <!-- Model Weights Section -->
        <div class="border-top pt-4">
          <h6 class="mb-3">
            <i class="fas fa-balance-scale me-2 text-info"></i>Bobot Model
          </h6>
          <div class="row">
            <div class="col-md-4 mb-3">
              <div class="weight-slider-container">
                <label for="w2v_weight" class="form-label">
                  <i class="fas fa-robot me-1 text-primary"></i>Word2Vec
                  <span class="badge bg-primary ms-2" id="w2v_weight_val">1.0</span>
                </label>
                <input type="range" class="form-range" min="0" max="2" step="0.1" id="w2v_weight" name="w2v_weight" value="1" />
                <div class="d-flex justify-content-between text-muted small">
                  <span>0.0</span>
                  <span class="weight-impact-indicator">Pengaruh: <span id="w2v_impact">Normal</span></span>
                  <span>2.0</span>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="weight-slider-container">
                <label for="ft_weight" class="form-label">
                  <i class="fas fa-font me-1 text-warning"></i>FastText
                  <span class="badge bg-warning text-dark ms-2" id="ft_weight_val">1.0</span>
                </label>
                <input type="range" class="form-range" min="0" max="2" step="0.1" id="ft_weight" name="ft_weight" value="1" />
                <div class="d-flex justify-content-between text-muted small">
                  <span>0.0</span>
                  <span class="weight-impact-indicator">Pengaruh: <span id="ft_impact">Normal</span></span>
                  <span>2.0</span>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="weight-slider-container">
                <label for="glove_weight" class="form-label">
                  <i class="fas fa-globe me-1 text-info"></i>GloVe
                  <span class="badge bg-info ms-2" id="glove_weight_val">1.0</span>
                </label>
                <input type="range" class="form-range" min="0" max="2" step="0.1" id="glove_weight" name="glove_weight" value="1" />
                <div class="d-flex justify-content-between text-muted small">
                  <span>0.0</span>
                  <span class="weight-impact-indicator">Pengaruh: <span id="glove_impact">Normal</span></span>
                  <span>2.0</span>
                </div>
              </div>
            </div>
          </div>
          <div class="alert alert-info mt-3 py-2">
            <small>
              <i class="fas fa-info-circle me-1"></i>
              <strong>Tips:</strong> Geser slider ke kanan untuk meningkatkan pengaruh model, ke kiri untuk mengurangi.
              Nilai 0.0 akan menonaktifkan model tersebut dari perhitungan ensemble.
            </small>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Loading Spinner -->
  <div id="ensemble-loading" class="text-center my-4" style="display:none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div>Memproses uji ensemble...</div>
  </div>

  <div id="ensemble-results" class="mt-4" style="display:none;">
    <div class="row">
      <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4 class="mb-0">Hasil Ensemble</h4>
          <div id="ensemble-summary" class="small text-muted"></div>
        </div>
        <!-- Method Indicator -->
        <!-- <div id="method-indicator" class="alert alert-info mb-3">
          <strong>Metode yang digunakan:</strong> <span id="current-method"></span>
        </div> -->
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Surah</th>
                <th>Ayat</th>
                <th>Skor Ensemble</th>
                <th>Word2Vec</th>
                <th>FastText</th>
                <th>GloVe</th>
                <th>Voting</th>
                <th>Meta</th>
              </tr>
            </thead>
            <tbody id="ensemble-table-body">
              <!-- Hasil akan diisi melalui JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="col-md-4">
        <div id="ensemble-visualization" class="mb-4">
          <h5>Visualisasi Kontribusi Model</h5>
          <div id="chart-container" style="height:300px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Detail Ayat -->
  <div class="modal fade" id="ayatDetailModal" tabindex="-1" aria-labelledby="ayatDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ayatDetailLabel">Detail Ayat</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="ayat-detail-body">
          <!-- Konten detail ayat -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- jQuery CDN (diperlukan untuk modal Bootstrap dan event handler) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/ensemble_test.js') }}"></script>
{% endblock %} 