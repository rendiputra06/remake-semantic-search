{% extends "layout_loggedin.html" %}

{% block title %}Admin - Evaluation Rule Management{% endblock %}

{% block page_content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-0">
                <i class="fas fa-flask me-2 text-primary"></i>
                Evaluation Management
            </h1>
            <p class="text-muted mt-1">Manage static evaluation results and overrides</p>
        </div>
        <a href="{{ url_for('admin.admin') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
        </a>
    </div>

    <!-- Alert Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="row">
        <!-- Upload Card -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-file-upload me-2"></i>Upload Data</h5>
                </div>
                <div class="card-body">
                    <p class="small text-muted">
                        Upload file CSV/Excel dengan format yang sesuai.
                        Anda dapat meninjau data sebelum disimpan.
                    </p>
                    <div class="mb-3">
                        <label for="csvFileInput" class="form-label">Pilih File CSV/Excel</label>
                        <input class="form-control" type="file" id="csvFileInput" accept=".csv,.xlsx,.xls">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="previewCheck" checked>
                        <label class="form-check-label" for="previewCheck">
                            Pratinjau data sebelum upload
                        </label>
                    </div>
                    <button type="button" id="btn-process-file" class="btn btn-success w-100">
                        <i class="fas fa-magic me-1"></i> Process File
                    </button>

                    <hr>
                    <div class="mt-3">
                        <h6>Format Kolom:</h6>
                        <ul class="small text-muted ps-3">
                            <li>Topic (Query Text)</li>
                            <li>W2V_Threshold (0.0 - 1.0)</li>
                            <li>FT_Threshold, GV_Threshold</li>
                            <li>Precision, Recall, F1_Score</li>
                            <li>TP, FP, FN (Integer)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data List Card -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Static Rules & Overrides</h5>
                    <span class="badge bg-secondary">{{ custom_evals|length }} Entries</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Topic</th>
                                    <th>Metric (P/R/F1)</th>
                                    <th>Thresholds</th>
                                    <th>Counts</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in custom_evals %}
                                <tr>
                                    <td class="fw-bold">{{ item.topic }}</td>
                                    <td>
                                        <div class="small">P: {{ "%.4f"|format(item.precision) }}</div>
                                        <div class="small">R: {{ "%.4f"|format(item.recall) }}</div>
                                        <div class="small fw-bold text-primary">F1: {{ "%.4f"|format(item.f1_score) }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark border">W:{{ item.w2v_threshold }}</span>
                                        <span class="badge bg-light text-dark border">F:{{ item.ft_threshold }}</span>
                                        <span class="badge bg-light text-dark border">G:{{ item.gv_threshold }}</span>
                                    </td>
                                    <td>
                                        <div class="small text-success">TP: {{ item.tp }}</div>
                                        <div class="small text-danger">FP: {{ item.fp }}</div>
                                        <div class="small text-warning">FN: {{ item.fn }}</div>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary btn-edit"
                                                data-id="{{ item.id }}" data-topic="{{ item.topic }}"
                                                data-precision="{{ item.precision }}" data-recall="{{ item.recall }}"
                                                data-f1="{{ item.f1_score }}" data-tp="{{ item.tp }}"
                                                data-fp="{{ item.fp }}" data-fn="{{ item.fn }}"
                                                data-w2v="{{ item.w2v_threshold }}" data-ft="{{ item.ft_threshold }}"
                                                data-gv="{{ item.gv_threshold }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger btn-delete"
                                                data-id="{{ item.id }}" data-topic="{{ item.topic }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <form id="delete-form-{{ item.id }}"
                                                action="{{ url_for('admin.delete_custom_eval') }}" method="POST"
                                                class="d-none">
                                                <input type="hidden" name="id" value="{{ item.id }}">
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        No entries found.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-eye me-2"></i>Pratinjau Data Upload</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive" style="max-height: 60vh;">
                    <table class="table table-sm table-bordered mb-0" id="previewTable">
                        <thead class="bg-light sticky-top">
                            <!-- Headers filled by JS -->
                        </thead>
                        <tbody>
                            <!-- Rows filled by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="px-3 py-2 bg-light border-top d-flex justify-content-between align-items-center">
                    <div id="preview-stats" class="small text-muted"></div>
                    <nav id="preview-pagination-container" aria-label="Page navigation" style="display: none;">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item"><button class="page-link" id="prev-page">Previous</button></li>
                            <li class="page-item disabled"><span class="page-link" id="current-page-info">Page 1 of
                                    1</span></li>
                            <li class="page-item"><button class="page-link" id="next-page">Next</button></li>
                        </ul>
                    </nav>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" id="btn-confirm-upload" class="btn btn-success">
                    <i class="fas fa-check-circle me-1"></i> Simpan Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editModalLabel">Edit Evaluation Result</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form id="editForm" action="{{ url_for('admin.update_custom_eval_route') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="id" id="edit-id">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Topic</label>
                        <input type="text" class="form-control bg-light" id="edit-topic" readonly>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label small">W2V Threshold</label>
                            <input type="text" class="form-control bg-light" id="edit-w2v" readonly>
                        </div>
                        <div class="col">
                            <label class="form-label small">FT Threshold</label>
                            <input type="text" class="form-control bg-light" id="edit-ft" readonly>
                        </div>
                        <div class="col">
                            <label class="form-label small">GV Threshold</label>
                            <input type="text" class="form-control bg-light" id="edit-gv" readonly>
                        </div>
                    </div>
                    <hr>
                    <h6>Metrics</h6>
                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <label class="form-label small">Precision</label>
                            <input type="number" step="0.0001" class="form-control" name="precision" id="edit-precision"
                                required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Recall</label>
                            <input type="number" step="0.0001" class="form-control" name="recall" id="edit-recall"
                                required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">F1 Score</label>
                            <input type="number" step="0.0001" class="form-control" name="f1_score" id="edit-f1"
                                required>
                        </div>
                    </div>
                    <h6>Counts</h6>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label small">TP</label>
                            <input type="number" class="form-control" name="tp" id="edit-tp" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">FP</label>
                            <input type="number" class="form-control" name="fp" id="edit-fp" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">FN</label>
                            <input type="number" class="form-control" name="fn" id="edit-fn" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Edit Modal ... -->
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        const editButtons = document.querySelectorAll('.btn-edit');
        const deleteButtons = document.querySelectorAll('.btn-delete');

        let parsedData = [];

        // Delete logic with SweetAlert2
        deleteButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.dataset.id;
                const topic = this.dataset.topic;

                Swal.fire({
                    title: 'Apakah Anda yakin?',
                    text: `Hapus rule untuk topik "${topic}"?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Ya, Hapus!',
                    cancelButtonText: 'Batal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        document.getElementById(`delete-form-${id}`).submit();
                    }
                });
            });
        });

        // Edit Modal logic
        editButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                document.getElementById('edit-id').value = this.dataset.id;
                document.getElementById('edit-topic').value = this.dataset.topic;
                document.getElementById('edit-precision').value = this.dataset.precision;
                document.getElementById('edit-recall').value = this.dataset.recall;
                document.getElementById('edit-f1').value = this.dataset.f1;
                document.getElementById('edit-tp').value = this.dataset.tp;
                document.getElementById('edit-fp').value = this.dataset.fp;
                document.getElementById('edit-fn').value = this.dataset.fn;
                document.getElementById('edit-w2v').value = this.dataset.w2v;
                document.getElementById('edit-ft').value = this.dataset.ft;
                document.getElementById('edit-gv').value = this.dataset.gv;
                editModal.show();
            });
        });

        // CSV/Excel processing
        const fileInput = document.getElementById('csvFileInput');
        const processBtn = document.getElementById('btn-process-file');
        const confirmBtn = document.getElementById('btn-confirm-upload');

        processBtn.addEventListener('click', function () {
            const file = fileInput.files[0];
            if (!file) {
                alert('Pilih file terlebih dahulu!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheet];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                parsedData = jsonData;
                renderPreview(jsonData);
                previewModal.show();
            };
            reader.readAsArrayBuffer(file);
        });

        let currentPage = 1;
        const rowsPerPage = 20;

        function renderPreview(data, page = 1) {
            const thead = document.querySelector('#previewTable thead');
            const tbody = document.querySelector('#previewTable tbody');
            const stats = document.getElementById('preview-stats');
            const paginationContainer = document.getElementById('preview-pagination-container');
            const pageInfo = document.getElementById('current-page-info');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">File kosong.</td></tr>';
                paginationContainer.style.display = 'none';
                return;
            }

            const headers = Object.keys(data[0]);
            thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';

            const totalPages = Math.ceil(data.length / rowsPerPage);
            currentPage = page;

            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = data.slice(start, end);

            tbody.innerHTML = pageData.map(row => {
                return '<tr>' + headers.map(h => `<td>${row[h] || ''}</td>`).join('') + '</tr>';
            }).join('');

            stats.innerHTML = `Loaded <strong>${data.length}</strong> rows. Columns found: ${headers.join(', ')}`;

            if (totalPages > 1) {
                paginationContainer.style.display = 'block';
                pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prev-page').parentElement.classList.toggle('disabled', currentPage === 1);
                document.getElementById('next-page').parentElement.classList.toggle('disabled', currentPage === totalPages);
            } else {
                paginationContainer.style.display = 'none';
            }
        }

        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) renderPreview(parsedData, currentPage - 1);
        });

        document.getElementById('next-page').addEventListener('click', () => {
            const totalPages = Math.ceil(parsedData.length / rowsPerPage);
            if (currentPage < totalPages) renderPreview(parsedData, currentPage + 1);
        });

        confirmBtn.addEventListener('click', async function () {
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Processing...';

            try {
                const response = await fetch('/admin/api/custom_eval/batch_save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: parsedData })
                });

                const result = await response.json();
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil',
                        text: result.message,
                        confirmButtonText: 'OK'
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    alert('Gagal menyimpan: ' + result.message);
                }
            } catch (error) {
                console.error(error);
                alert('Terjadi kesalahan saat menyimpan data.');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i> Simpan Data';
            }
        });
    });
</script>
{% endblock %}